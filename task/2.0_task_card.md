````markdown
# 任务卡：图片编辑工具 — 第 2 次迭代开发任务（拉取图片打开 + 切图模式工作栏）

本任务卡用于一次性完成本轮全部迭代内容，适用于 **Python GUI 应用**（Tkinter / PyQt / PySide 任意，但需保持当前项目框架不被破坏）。  
请严格遵守下方**约束规则**，并在约束下完成所有功能开发。

---

# 一、开发强约束（务必严格遵守）

## 1. 不允许破坏现有功能
- **不得重写或删除**当前已实现的功能（裁剪 / 切图 / 显示图片 / 已有快捷键）。
- 不允许修改已有功能的默认行为（除本次需求明确要求的部分）。

## 2. 不允许大幅重构 UI 架构
- 不得重写整个主窗口、主布局结构。
- 不得更换现有 GUI 框架（仍需保持当前 Tkinter / PyQt 系体系）。

## 3. 允许新增内容但不得随意修改已有代码块
- 可新增：
  - 左侧“工作栏”区域  
  - 新状态变量、属性、数据结构  
  - 新事件绑定、新按钮  
  - 新逻辑函数、新类
- **不得随意修改**现有控件命名、路径变量、渲染方法。

## 4. 所有新增行为必须与现有逻辑兼容
- 切图模式原有功能继续保留（部分需求明确取消除外）。
- 不得影响裁剪模式 UI/操作。

---

# 二、本次迭代需求说明（Codex 必须实现全部内容）

以下需求为 **强需求**，必须一次性全部完成。

---

## 1. 新增：拉取图片到工作区打开图片功能（Drag & Drop）

### 功能目标
用户直接把图片文件拖到“工作区（画布区域）”即可打开，无需按菜单或按钮。

### 实现要求
- 工作区支持文件拖拽（DragEnter / Drop events）。
- 判断文件是否为图片（jpg/png/webp/jpeg）。
- 加载图片 → 重置画布视图（缩放至合适大小）。
- 切图模式下：
  - 清空旧的切割线数据；
  - 保持模式不变；
- 捕获不支持文件类型 → 显示错误提示。

### 约束
- 不得修改原本的“从菜单/按钮打开图片”的功能。
- 不得改变图片加载函数的接口结构，如需扩展，需 **增加包装方法**。

---

## 2. 切图模式：新增左侧“工作栏”（Side Panel）

此区域仅在 **切图模式下显示**。

### 工作栏整体结构（从上到下）
1. 切图方式（二选一）  
2. 行列生成网格区域（当选择“网格模式”显示）  
3. 手动切割线区域（当选择“手动模式”显示）  
4. 鼠标选择工具（左键选择切割线）  
5. 执行切图按钮

---

## 3. 切图方式：二选一（radio-like 选择）
新增状态变量：
```python
self.sliceMode = "grid" | "manual"
````

UI：

* 【行列生成网格】
* 【手动生成切割线】

行为：

* 二选一；切换时自动刷新工作区渲染。
* 切换到 manual 时，可选择是否弹窗提示：

  * “切换到手动模式将清除当前网格线”
* 若弹窗，选择确认后清空切割线数据。

---

## 4. 切图方式 ①：行列生成网格（自动）

UI 组件（显示在工作栏）：

* 输入框：行数（N）
* 输入框：列数（M）

行为要求：

1. 输入正整数时自动重绘切割线：

   * 根据图片尺寸计算等分线的位置；
   * N 行生成 N–1 条水平线；
   * M 列生成 M–1 条垂直线；
2. 切换到网格模式后：

   * 禁止手动加线；
   * 禁止选中线；
   * 禁止拖动线；
3. 切换到其它模式时：

   * 清空网格线。

---

## 5. 切图方式 ②：手动生成切割线

新增状态变量：

```python
self.lineTool = "horizontal" | "vertical" | "cross" | "select"
```

### 要求：取消“左键默认生成十字线”的行为

* 原行为：鼠标左键 = 生成十字切割线
* 现在必须改为：

  * **只有当 lineTool="cross" 时，左键才生成十字线**

### 手动工具按钮（3 个切割线工具）

* 水平线（H）：lineTool = "horizontal"
* 垂直线（V）：lineTool = "vertical"
* 十字线（+）：lineTool = "cross"

按钮特性：

* 三选一，高亮当前工具；
* 若切换到其它工具，之前的工具取消高亮。

---

## 6. 新增：鼠标选择工具（选择切割线）

新增按钮（鼠标 icon）：

* 点击按钮 → `lineTool = "select"`

行为规范：

* 左键行为：

  * 不再生成切割线；
  * 改为：检查是否点击到某条切割线附近；
  * 若命中 → 选中该切割线；
* 选中效果需“非常明显”：

  * 线条高亮颜色；
  * 或线条变粗；
  * 可选：显示拖拽端点句柄（小圆点）

> 提醒：后续可扩展“拖动线”功能，但本次迭代**最少要实现明显选中效果**。

---

## 7. 手动生成切割线：鼠标绘制行为

当 lineTool = "horizontal":

* 左键点击画布 → 在该 Y 坐标生成一条水平线

当 lineTool = "vertical":

* 左键点击画布 → 在该 X 坐标生成一条垂直线

当 lineTool = "cross":

* 左键点击画布 → 同时生成水平线 + 垂直线（交叉）

当 lineTool = "select":

* 左键点击画布 → 尝试选中切割线，不生成新线

تحقیقات

---

## 8. 保留快捷键行为（水平线 / 垂直线）

快捷键规则保持不变：

* H：生成水平线（与线工具选中状态无关，只要在切图模式都可用）
* V：生成垂直线

### 但必须：

* **不再生成十字线**
* 不触发其它自动行为

---

## 9. 新增：【执行切图】按钮（工作栏底部）

位置：左侧工作栏最底部

行为流程：

1. 根据当前切割线列表（网格或手动）计算各个区域的裁剪坐标；
2. 调用已有切图功能执行批量生成；
3. 切图成功后提示：

   * “切图完成，共生成 X 个切片”
4. 可选：弹出“打开输出文件夹”按钮。

约束：

* 不改变原有切图算法；如需扩展，请新增辅助函数，不要覆盖已有函数。

---

# 三、数据结构及状态管理（Codex 按此实现）

必须新增的核心属性：

```python
self.sliceMode = "grid" or "manual"
self.lineTool = "horizontal" or "vertical" or "cross" or "select"
self.cutLines = []   # 所有切割线的数据结构列表
```

切割线数据格式建议：

```python
{
  "type": "horizontal" | "vertical",
  "pos": float,          # 在线条方向上的绝对像素位置
  "selected": bool       # 是否被选中（UI 渲染时需加粗或变色）
}
```

网格线生成后的 cutLines 也按此结构保存（type + pos）。

---

# 四、渲染规则（画布绘制层）

1. **所有线均按 cutLines[] 绘制**
2. 若 line["selected"] == True：

   * 用加粗或亮色绘制
3. 若 sliceMode="grid"：

   * 禁止渲染“选中”效果（因为用户不能选择网格线）
4. 鼠标 hover 不做处理（可迭代）

---

# 五、最终交付要求（Codex 必须执行到位）

1. 工作栏 UI 可正常显示/隐藏
2. 行列输入 → 自动生成网格线
3. 手动模式 → 使用工具按钮生成切割线
4. 鼠标选择工具可正确选中线条
5. 拖入图片 → 正确加载
6. 执行切图 → 按切割线结构进行分片
7. 所有功能在现有 UI 架构下工作，不破坏原有功能
8. 所有新增功能均需配套注释，便于阅读和迭代
9. 保持代码结构清晰：GUI 部分、业务逻辑、绘制逻辑分明

---

# 六、可选优化（非必须，本次迭代可以不做）

* 为选中的切割线添加删除逻辑（Delete 键）（本次迭代实现）
* 为切割线添加拖动逻辑（本次迭代实现）
* 增加配置项：切图输出命名规则
* 工作栏可折叠

---

# 七、执行提醒（务必遵守）

> ❗ 请严格遵循本任务卡，不得：
>
> * 重构项目结构
> * 改写现有布局
> * 更改已有变量/函数的行为
> * 删除已有的 UI 或功能
> * 自主删改已有快捷键
> * 改动裁剪模式逻辑

> ❗ 所有新增功能必须在现有基础上“增量式”实现，不得推翻重写。

---

如需，我还能帮你生成对应的：

✔《后端无关逻辑抽象图》
✔《切割线状态机》
✔《迭代后整体 UI 框架示意图》
✔《画布渲染优先级规则》

只要告诉我即可。

```
```
